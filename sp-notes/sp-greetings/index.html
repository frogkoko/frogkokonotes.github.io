<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Greetings Practice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #090327, #010b02);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 100%;
        }
        .back-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .conversation-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            max-width: 700px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .conversation {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .message:hover {
            transform: scale(1.02);
        }
        .message.a {
            align-self: flex-start;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-bottom-left-radius: 0;
        }
        .message.b {
            align-self: flex-end;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-bottom-right-radius: 0;
        }
        .speak-btn {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #3498db;
        }
        .message.b .speak-btn {
            left: -30px;
            right: auto;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        .control-btn.active {
            background: rgba(255, 255, 255, 0.6);
        }
        .instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
        }
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .instructions p {
            color: #34495e;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .voice-info {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1rem;
            opacity: 0.9;
        }
        .vocab-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            color: #333;
        }
        .translation {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Test Section Styles */
        .test-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            max-width: 700px;
            width: 100%;
            display: none;
        }
        .test-container.active {
            display: block;
        }
        .test-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5rem;
        }
        .question {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .option {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.selected {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .option.correct {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .option.incorrect {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .test-btn:hover {
            background: #2980b9;
        }
        .test-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
        }
        .results.show {
            display: block;
        }
        .score {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .feedback {
            font-style: italic;
            color: #6c757d;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }
        .status.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="../../index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Spanish Greetings Practice</h1>
            <p class="subtitle">Speaker A: English | Speaker B: Spanish (OpenAI Nova Voice)</p>
        </header>
        
        <div class="voice-info">
            <p>Using OpenAI TTS with Nova voice for Spanish pronunciation</p>
        </div>
        
        <div class="conversation-container">
            <div class="conversation" id="conversation">
                <!-- Messages will be added here dynamically -->
            </div>
        </div>
        
        <div class="test-container" id="test-container">
            <h2 class="test-title">Comprehension Test</h2>
            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>
            <div class="test-controls">
                <button class="test-btn" id="prev-question-btn" disabled>Previous Question</button>
                <button class="test-btn" id="check-answer-btn">Check Answer</button>
                <button class="test-btn" id="next-question-btn">Next Question</button>
            </div>
            <div class="results" id="results">
                <div class="score" id="score-text"></div>
                <div class="feedback" id="feedback-text"></div>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="prev-btn">Previous</button>
            <button class="control-btn" id="next-btn">Next</button>
            <button class="control-btn" id="test-btn">Take Test</button>
            <button class="control-btn" id="reset-btn">Reset</button>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="instructions">
            <h3>How to Use</h3>
            <p><strong>Click on a message</strong> to hear it spoken in Spanish using the OpenAI Nova voice.</p>
            <p><strong>Speaker A</strong> speaks English, <strong>Speaker B</strong> responds in Spanish.</p>
            <p><strong>Next/Previous:</strong> Navigate through the conversation.</p>
            <p><strong>Take Test:</strong> Test your understanding of the current conversation.</p>
            <p><strong>Reset:</strong> Start the conversation from the beginning.</p>
            <p><strong>Vocabulary:</strong> Key Spanish words are highlighted in yellow for easier learning.</p>
        </div>
    </div>
    <script src="https://js.puter.com/v2/"></script>
    <script>
        const conversations = [
            // Basic Greetings
            [
                { speaker: 'a', text: "Hello", translation: "" },
                { speaker: 'b', text: "¡Hola! ¿Cómo estás?" }
            ],
            [
                { speaker: 'a', text: "I'm fine, thank you. And you?", translation: "" },
                { speaker: 'b', text: "Muy bien, gracias. ¿Y tú?" }
            ],
            [
                { speaker: 'a', text: "What is your name?", translation: "" },
                { speaker: 'b', text: "Me llamo María. ¿Y tú?" }
            ],
            [
                { speaker: 'a', text: "My name is John. Nice to meet you.", translation: "" },
                { speaker: 'b', text: "Mucho gusto, John." }
            ],
            [
                { speaker: 'a', text: "Where are you from?", translation: "" },
                { speaker: 'b', text: "Soy de España. ¿Y tú?" }
            ],
            // Time-based Greetings
            [
                { speaker: 'a', text: "Good morning!", translation: "" },
                { speaker: 'b', text: "¡Buenos días!"}
            ],
            [
                { speaker: 'a', text: "Good afternoon!", translation: "" },
                { speaker: 'b', text: "¡Buenas tardes!" }
            ],
            [
                { speaker: 'a', text: "Good evening!", translation: "" },
                { speaker: 'b', text: "¡Buenas noches!" }
            ],
            // Farewells
            [
                { speaker: 'a', text: "Goodbye!", translation: "" },
                { speaker: 'b', text: "¡Adiós!"}
            ],
            [
                { speaker: 'a', text: "See you later!", translation: "" },
                { speaker: 'b', text: "¡Hasta luego!" }
            ],
            [
                { speaker: 'a', text: "See you tomorrow!", translation: "" },
                { speaker: 'b', text: "¡Hasta mañana!"}
            ],
            // Polite Expressions
            [
                { speaker: 'a', text: "Thank you very much!", translation: "" },
                { speaker: 'b', text: "¡Muchas gracias!"}
            ],
            [
                { speaker: 'a', text: "You're welcome.", translation: "" },
                { speaker: 'b', text: "De nada." }
            ],
            [
                { speaker: 'a', text: "Excuse me.", translation: "" },
                { speaker: 'b', text: "Perdón." }
            ],
            [
                { speaker: 'a', text: "I'm sorry.", translation: "" },
                { speaker: 'b', text: "Lo siento." }
            ],
            // Asking about well-being
            [
                { speaker: 'a', text: "How have you been?", translation: "" },
                { speaker: 'b', text: "¿Cómo has estado?" }
            ],
            [
                { speaker: 'a', text: "Everything is fine, thanks.", translation: "" },
                { speaker: 'b', text: "Todo bien, gracias." }
            ]
        ];

        // Test questions for each conversation
        const testQuestions = [
            // Tests for basic greetings
            [
                {
                    question: "What does '¿Cómo estás?' mean?",
                    options: [
                        "How are you?",
                        "What is your name?",
                        "Where are you from?",
                        "Nice to meet you."
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How do you say 'Nice to meet you' in Spanish?",
                    options: [
                        "Mucho gusto",
                        "Hola",
                        "Gracias",
                        "Adiós"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What is the response to '¿Cómo estás?' when you're doing well?",
                    options: [
                        "Muy bien, gracias",
                        "Me llamo...",
                        "Soy de...",
                        "Hasta luego"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does '¿Y tú?' mean?",
                    options: [
                        "And you?",
                        "How are you?",
                        "What's your name?",
                        "Thank you"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "How do you ask 'What is your name?' in Spanish?",
                    options: [
                        "¿Cómo te llamas?",
                        "¿Cómo estás?",
                        "¿De dónde eres?",
                        "Mucho gusto"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Me llamo María' mean?",
                    options: [
                        "My name is Maria",
                        "I am from Maria",
                        "How are you Maria",
                        "Nice to meet you Maria"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "How do you respond to 'Mucho gusto'?",
                    options: [
                        "Mucho gusto también",
                        "Hola",
                        "Adiós",
                        "Gracias"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What is the Spanish equivalent of 'Nice to meet you'?",
                    options: [
                        "Mucho gusto",
                        "Hola",
                        "Buenos días",
                        "Hasta luego"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "How do you ask 'Where are you from?' in Spanish?",
                    options: [
                        "¿De dónde eres?",
                        "¿Cómo estás?",
                        "¿Cómo te llamas?",
                        "¿Qué tal?"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Soy de España' mean?",
                    options: [
                        "I'm from Spain",
                        "I'm Spanish",
                        "I like Spain",
                        "I'm going to Spain"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for time-based greetings
            [
                {
                    question: "How do you say 'Good morning' in Spanish?",
                    options: [
                        "Buenos días",
                        "Buenas tardes",
                        "Buenas noches",
                        "Hola"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "When would you use 'Buenas tardes'?",
                    options: [
                        "In the afternoon",
                        "In the morning",
                        "In the evening",
                        "At night"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What is the Spanish greeting for 'Good afternoon'?",
                    options: [
                        "Buenas tardes",
                        "Buenos días",
                        "Buenas noches",
                        "Hola"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "When would you use 'Buenas noches'?",
                    options: [
                        "In the evening/night",
                        "In the morning",
                        "In the afternoon",
                        "At any time"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What does 'Buenas noches' mean?",
                    options: [
                        "Good evening/night",
                        "Good morning",
                        "Good afternoon",
                        "Good day"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "Which greeting would you use when meeting someone at 8 PM?",
                    options: [
                        "Buenas noches",
                        "Buenos días",
                        "Buenas tardes",
                        "Hola"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for farewells
            [
                {
                    question: "How do you say 'Goodbye' in Spanish?",
                    options: [
                        "Adiós",
                        "Hola",
                        "Gracias",
                        "Por favor"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What is a casual way to say 'See you later' in Spanish?",
                    options: [
                        "Hasta luego",
                        "Adiós",
                        "Hasta mañana",
                        "Buenas noches"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What does 'Hasta luego' mean?",
                    options: [
                        "See you later",
                        "Goodbye",
                        "See you tomorrow",
                        "Hello"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How do you say 'See you tomorrow' in Spanish?",
                    options: [
                        "Hasta mañana",
                        "Hasta luego",
                        "Adiós",
                        "Buenos días"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What is the difference between 'Adiós' and 'Hasta luego'?",
                    options: [
                        "Adiós is more final, Hasta luego implies you'll see the person again",
                        "Adiós is informal, Hasta luego is formal",
                        "Adiós is for mornings, Hasta luego for afternoons",
                        "There is no difference"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "When would you use 'Hasta mañana'?",
                    options: [
                        "When you expect to see the person tomorrow",
                        "When saying goodbye forever",
                        "When greeting someone in the morning",
                        "When thanking someone"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for polite expressions
            [
                {
                    question: "How do you say 'Thank you very much' in Spanish?",
                    options: [
                        "Muchas gracias",
                        "De nada",
                        "Por favor",
                        "Lo siento"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What is the appropriate response to 'Gracias'?",
                    options: [
                        "De nada",
                        "Por favor",
                        "Lo siento",
                        "Hola"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What does 'De nada' mean?",
                    options: [
                        "You're welcome",
                        "Thank you",
                        "Excuse me",
                        "I'm sorry"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How do you say 'Excuse me' in Spanish?",
                    options: [
                        "Perdón",
                        "Gracias",
                        "De nada",
                        "Hola"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What does 'Lo siento' mean?",
                    options: [
                        "I'm sorry",
                        "Excuse me",
                        "Thank you",
                        "You're welcome"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "When would you use 'Perdón'?",
                    options: [
                        "To get someone's attention or apologize for a minor issue",
                        "To thank someone",
                        "To say goodbye",
                        "To introduce yourself"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What is the difference between 'Perdón' and 'Lo siento'?",
                    options: [
                        "Perdón is for minor issues, Lo siento for more serious apologies",
                        "Perdón is formal, Lo siento is informal",
                        "Perdón is for thanking, Lo siento for apologizing",
                        "There is no difference"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you respond to 'Lo siento'?",
                    options: [
                        "No hay problema",
                        "Gracias",
                        "De nada",
                        "Hola"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for asking about well-being
            [
                {
                    question: "How do you ask 'How have you been?' in Spanish?",
                    options: [
                        "¿Cómo has estado?",
                        "¿Cómo estás?",
                        "¿Qué tal?",
                        "¿Cómo te llamas?"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Todo bien' mean?",
                    options: [
                        "Everything is fine",
                        "How are you?",
                        "Thank you",
                        "Goodbye"
                    ],
                    correctAnswer: 0
                }
            ],
            [
                {
                    question: "What is a common response to '¿Cómo has estado?'?",
                    options: [
                        "Todo bien, gracias",
                        "Me llamo...",
                        "Soy de...",
                        "Hasta luego"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How is '¿Cómo has estado?' different from '¿Cómo estás?'?",
                    options: [
                        "¿Cómo has estado? asks about a period of time, ¿Cómo estás? asks about now",
                        "¿Cómo has estado? is formal, ¿Cómo estás? is informal",
                        "¿Cómo has estado? is for greetings, ¿Cómo estás? for farewells",
                        "There is no difference"
                    ],
                    correctAnswer: 0
                }
            ]
        ];

        // Spanish vocabulary to highlight
        const vocabWords = [
            "Hola", "Buenos días", "Buenas tardes", "Buenas noches", "Adiós", 
            "Hasta luego", "Hasta mañana", "Gracias", "Muchas gracias", "De nada", 
            "Por favor", "Perdón", "Lo siento", "¿Cómo estás?", "Estoy bien", 
            "Muy bien", "Mal", "Regular", "¿Y tú?", "Me llamo", 
            "¿Cómo te llamas?", "Mucho gusto", "Encantado", "Encantada", "¿De dónde eres?", 
            "Soy de", "España", "México", "Argentina", "Colombia", 
            "Estados Unidos", "Inglaterra", "Francia", "Alemania", "Italia"
        ];

        let currentConversationIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let testStarted = false;
        
        const conversationElement = document.getElementById('conversation');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');
        const testBtn = document.getElementById('test-btn');
        const testContainer = document.getElementById('test-container');
        const questionsContainer = document.getElementById('questions-container');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const results = document.getElementById('results');
        const scoreText = document.getElementById('score-text');
        const feedbackText = document.getElementById('feedback-text');
        const statusElement = document.getElementById('status');
        
        // Function to highlight vocabulary words
        function highlightVocabulary(text) {
            let highlightedText = text;
            vocabWords.forEach(word => {
                const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="vocab-highlight">$&</span>`);
            });
            return highlightedText;
        }

        function renderConversation() {
            conversationElement.innerHTML = '';
            const currentConversation = conversations[currentConversationIndex];
            
            currentConversation.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.speaker}`;
                
                // Highlight vocabulary words for Spanish messages
                let displayText = message.text;
                if (message.speaker === 'b') {
                    displayText = highlightVocabulary(message.text);
                }
                
                messageElement.innerHTML = `
                    ${displayText}
                    ${message.translation ? `<div class="translation">${message.translation}</div>` : ''}
                    <button class="speak-btn" data-text="${message.speaker === 'b' ? message.text : ''}" data-speaker="${message.speaker}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                `;
                conversationElement.appendChild(messageElement);
            });
            
            // Add event listeners to speak buttons
            document.querySelectorAll('.speak-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const text = e.target.closest('.speak-btn').dataset.text;
                    const speaker = e.target.closest('.speak-btn').dataset.speaker;
                    if (speaker === 'b') {
                        speak(text);
                    }
                });
            });
            
            // Add event listeners to messages
            document.querySelectorAll('.message').forEach(message => {
                message.addEventListener('click', (e) => {
                    if (!e.target.closest('.speak-btn')) {
                        const speaker = message.classList.contains('a') ? 'a' : 'b';
                        if (speaker === 'b') {
                            // Get the original text without HTML tags for speaking
                            const text = message.textContent.trim().split('\n')[0];
                            speak(text);
                        }
                    }
                });
            });
        }

        async function speak(text) {
            updateStatus('Converting text to speech...', 'active');
            
            try {
                const audio = await puter.ai.txt2speech(text, {
                    provider: 'openai',
                    voice: 'nova',
                    model: 'gpt-4o-mini-tts',
                    response_format: 'mp3'
                });
                
                updateStatus('Playing audio...', 'active');
                
                await audio.play();
                
                // Reset status when audio finishes
                audio.addEventListener('ended', () => {
                    updateStatus('', '');
                });
                
                audio.addEventListener('error', (e) => {
                    updateStatus('Error playing audio', 'active');
                    console.error('Audio playback error:', e);
                });
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'active');
                console.error('TTS Error:', error);
                
                // Fallback to browser TTS if OpenAI fails
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    speechSynthesis.speak(utterance);
                    
                    utterance.onend = () => {
                        updateStatus('', '');
                    };
                }
            }
        }

        function updateStatus(message, className) {
            statusElement.textContent = message;
            statusElement.className = 'status';
            if (className) {
                statusElement.classList.add(className);
            }
        }

        function startTest() {
            testStarted = true;
            currentQuestionIndex = 0;
            userAnswers = new Array(testQuestions[currentConversationIndex].length).fill(null);
            testContainer.classList.add('active');
            renderQuestion();
            updateTestControls();
            results.classList.remove('show');
        }

        function renderQuestion() {
            questionsContainer.innerHTML = '';
            const questions = testQuestions[currentConversationIndex];
            const question = questions[currentQuestionIndex];
            
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.innerHTML = `
                <div class="question-text">${currentQuestionIndex + 1}. ${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) => `
                        <div class="option ${userAnswers[currentQuestionIndex] === index ? 'selected' : ''}" data-index="${index}">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;
            
            questionsContainer.appendChild(questionElement);
            
            // Add event listeners to options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Store user's answer
                    userAnswers[currentQuestionIndex] = parseInt(option.dataset.index);
                    
                    // Enable check answer button
                    checkAnswerBtn.disabled = false;
                });
            });
        }

        function updateTestControls() {
            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            nextQuestionBtn.disabled = currentQuestionIndex === testQuestions[currentConversationIndex].length - 1;
            checkAnswerBtn.disabled = userAnswers[currentQuestionIndex] === null;
        }

        function checkAnswer() {
            const questions = testQuestions[currentConversationIndex];
            const question = questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            
            // Show correct/incorrect styling
            document.querySelectorAll('.option').forEach(option => {
                const index = parseInt(option.dataset.index);
                if (index === question.correctAnswer) {
                    option.classList.add('correct');
                } else if (index === userAnswer && userAnswer !== question.correctAnswer) {
                    option.classList.add('incorrect');
                }
            });
            
            // Disable further selection
            document.querySelectorAll('.option').forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            checkAnswerBtn.disabled = true;
            
            // If this is the last question, show results
            if (currentQuestionIndex === questions.length - 1) {
                showResults();
            }
        }

        function showResults() {
            const questions = testQuestions[currentConversationIndex];
            let correctCount = 0;
            
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) {
                    correctCount++;
                }
            });
            
            const score = Math.round((correctCount / questions.length) * 100);
            scoreText.textContent = `Your Score: ${score}% (${correctCount}/${questions.length})`;
            
            // Provide feedback based on score
            if (score >= 90) {
                feedbackText.textContent = "¡Excelente! You have a great understanding of these Spanish greetings.";
            } else if (score >= 70) {
                feedbackText.textContent = "¡Muy bien! You understood most of the Spanish greetings.";
            } else if (score >= 50) {
                feedbackText.textContent = "Not bad! Review the conversation and try again.";
            } else {
                feedbackText.textContent = "Keep practicing! Listen to the conversation again and pay attention to the Spanish phrases.";
            }
            
            results.classList.add('show');
        }

        // Event listeners for conversation navigation
        prevBtn.addEventListener('click', () => {
            if (currentConversationIndex > 0) {
                currentConversationIndex--;
                renderConversation();
                testContainer.classList.remove('active');
                testStarted = false;
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentConversationIndex < conversations.length - 1) {
                currentConversationIndex++;
                renderConversation();
                testContainer.classList.remove('active');
                testStarted = false;
            }
        });

        resetBtn.addEventListener('click', () => {
            currentConversationIndex = 0;
            renderConversation();
            testContainer.classList.remove('active');
            testStarted = false;
        });

        testBtn.addEventListener('click', () => {
            startTest();
        });

        // Event listeners for test navigation
        prevQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
                updateTestControls();
            }
        });

        nextQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex < testQuestions[currentConversationIndex].length - 1) {
                currentQuestionIndex++;
                renderQuestion();
                updateTestControls();
            }
        });

        checkAnswerBtn.addEventListener('click', checkAnswer);

        // Initial render
        renderConversation();
    </script>
</body>
</html>