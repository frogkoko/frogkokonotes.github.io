<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Greetings Practice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #090327, #010b02);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 100%;
        }
        .back-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .conversation-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            max-width: 700px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .conversation {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .message:hover {
            transform: scale(1.02);
        }
        .message.a {
            align-self: flex-start;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-bottom-left-radius: 0;
        }
        .message.b {
            align-self: flex-end;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-bottom-right-radius: 0;
        }
        .speak-btn {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #3498db;
        }
        .message.b .speak-btn {
            left: -30px;
            right: auto;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        .control-btn.active {
            background: rgba(255, 255, 255, 0.6);
        }
        .instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
        }
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .instructions p {
            color: #34495e;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .voice-info {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1rem;
            opacity: 0.9;
        }
        .vocab-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            color: #333;
        }
        .translation {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Test Section Styles */
        .test-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            max-width: 700px;
            width: 100%;
            display: none;
        }
        .test-container.active {
            display: block;
        }
        .test-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5rem;
        }
        .question {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .option {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.selected {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .option.correct {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .option.incorrect {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .test-btn:hover {
            background: #2980b9;
        }
        .test-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
        }
        .results.show {
            display: block;
        }
        .score {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .feedback {
            font-style: italic;
            color: #6c757d;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }
        .status.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="../../index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Spanish Greetings Practice</h1>
            <p class="subtitle">Speaker A: English | Speaker B: Spanish (OpenAI Nova Voice)</p>
        </header>
        
        <div class="voice-info">
            <p>Using OpenAI TTS with Nova voice for Spanish pronunciation</p>
        </div>
        
        <div class="conversation-container">
            <div class="conversation" id="conversation">
                <!-- Messages will be added here dynamically -->
            </div>
        </div>
        
        <div class="test-container" id="test-container">
            <h2 class="test-title">Comprehension Test</h2>
            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>
            <div class="test-controls">
                <button class="test-btn" id="prev-question-btn" disabled>Previous Question</button>
                <button class="test-btn" id="check-answer-btn">Check Answer</button>
                <button class="test-btn" id="next-question-btn">Next Question</button>
            </div>
            <div class="results" id="results">
                <div class="score" id="score-text"></div>
                <div class="feedback" id="feedback-text"></div>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="prev-btn">Previous</button>
            <button class="control-btn" id="next-btn">Next</button>
            <button class="control-btn" id="test-btn">Take Test</button>
            <button class="control-btn" id="reset-btn">Reset</button>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="instructions">
            <h3>How to Use</h3>
            <p><strong>Click on Speaker A's message</strong> to hear the Spanish translation.</p>
            <p><strong>Click on Speaker B's message</strong> to hear it spoken in Spanish using the OpenAI Nova voice.</p>
            <p><strong>Speaker A</strong> speaks English, <strong>Speaker B</strong> responds in Spanish.</p>
            <p><strong>Next/Previous:</strong> Navigate through the conversation.</p>
            <p><strong>Take Test:</strong> Test your understanding of the current conversation.</p>
            <p><strong>Reset:</strong> Start the conversation from the beginning.</p>
            <p><strong>Vocabulary:</strong> Key Spanish words are highlighted in yellow for easier learning.</p>
        </div>
    </div>
    <script src="https://js.puter.com/v2/"></script>
    <script>
        const conversations = [
            // Conversation 1: Basic Introduction
            [
                { speaker: 'a', text: "Hello, my name is Carlos. Nice to meet you.", translation: "Hola, me llamo Carlos. Mucho gusto." },
                { speaker: 'b', text: "Mucho gusto, Carlos. Soy Elena. ¿A qué te dedicas?" },
                { speaker: 'a', text: "I'm a teacher, what about you?", translation: "Soy profesor, ¿y tú?" },
                { speaker: 'b', text: "Igual, también soy profesor. Enseño matemáticas en una escuela secundaria." }
            ],
            // Conversation 2: Work and Location
            [
                { speaker: 'a', text: "Good morning! I'm David. I work as an engineer in a tech company.", translation: "¡Buenos días! Soy David. Trabajo como ingeniero en una empresa de tecnología." },
                { speaker: 'b', text: "Encantada, David. Soy Sofía. Soy profesora de historia en la universidad." },
                { speaker: 'a', text: "That's interesting! Where do you live?", translation: "¡Qué interesante! ¿Dónde vives?" },
                { speaker: 'b', text: "Vivo cerca del centro, en un apartamento pequeño. ¿Y tú?" }
            ],
            // Conversation 3: Family and Hobbies
            [
                { speaker: 'a', text: "Hi, I'm Ana. I'm a doctor at the city hospital. I have two sons and one daughter.", translation: "Hola, soy Ana. Soy doctora en el hospital de la ciudad. Tengo dos hijos y una hija." },
                { speaker: 'b', text: "¡Qué bien! Soy Miguel. Trabajo en marketing. Tengo tres hijas y me encanta pasar tiempo con ellas." },
                { speaker: 'a', text: "For fun, I like to read books and play soccer with my kids.", translation: "Para divertirme, me gusta leer libros y jugar fútbol con mis hijos." },
                { speaker: 'b', text: "¡A mí también me encantan los deportes! Juego al tenis los fines de semana con mis hijas." }
            ],
            // Conversation 4: Extended Family
            [
                { speaker: 'a', text: "I'm married and we have one son. He's five years old.", translation: "Estoy casado y tenemos un hijo. Tiene cinco años." },
                { speaker: 'b', text: "Soy soltero y vivo con mi perro. Pero vengo de una familia grande - tengo tres hermanos y dos hermanas." },
                { speaker: 'a', text: "Wow, that is a big family! I'm an only child.", translation: "¡Vaya, eso es una familia grande! Yo soy hijo único." },
                { speaker: 'b', text: "Sí, siempre hay mucha actividad en mi casa cuando visito a mis padres." }
            ],
            // Conversation 5: Hobbies and Travel
            [
                { speaker: 'a', text: "In my free time, I enjoy cooking and traveling. Last year I visited Italy.", translation: "En mi tiempo libre, disfruto cocinar y viajar. El año pasado visité Italia." },
                { speaker: 'b', text: "¡Qué interesante! A mí también me encanta viajar. Visito nuevos países cada año. El próximo mes voy a Japón." },
                { speaker: 'a', text: "That sounds amazing! I'd love to visit Japan someday.", translation: "¡Eso suena increíble! Me encantaría visitar Japón algún día." },
                { speaker: 'b', text: "Te recomiendo que vayas. La comida y la cultura son fascinantes." }
            ],
            // Conversation 6: Complete Introduction
            [
                { speaker: 'a', text: "Let me introduce myself. I'm Laura, I'm a graphic designer, and I have two sons. For fun, I paint and go hiking.", translation: "Permíteme presentarme. Soy Laura, soy diseñadora gráfica y tengo dos hijos. Para divertirme, pinto y hago senderismo." },
                { speaker: 'b', text: "¡Mucho gusto, Laura! Soy Roberto. Soy arquitecto, tengo una hija y me encanta la fotografía y el ciclismo." },
                { speaker: 'a', text: "That's wonderful! How old is your daughter?", translation: "¡Eso es maravilloso! ¿Cuántos años tiene tu hija?" },
                { speaker: 'b', text: "Tiene siete años y ya le encanta dibujar y pintar, como a ti." }
            ],
            // Conversation 7: Age and Living Situation
            [
                { speaker: 'a', text: "I'm 35 years old and I live in Madrid with my family.", translation: "Tengo 35 años y vivo en Madrid con mi familia." },
                { speaker: 'b', text: "Tengo 32 años y vivo en Barcelona. Trabajo como desarrollador de software desde casa." },
                { speaker: 'a', text: "Working from home must be convenient. Do you like Barcelona?", translation: "Trabajar desde casa debe ser conveniente. ¿Te gusta Barcelona?" },
                { speaker: 'b', text: "Sí, me encanta. Es una ciudad vibrante con mucha cultura y buena comida." }
            ],
            // Conversation 8: Weekend Activities
            [
                { speaker: 'a', text: "On weekends, I usually go to the park with my children or visit friends.", translation: "Los fines de semana, suelo ir al parque con mis hijos o visitar amigos." },
                { speaker: 'b', text: "Eso suena divertido. Yo normalmente voy al gimnasio o salgo a cenar con mis amigos." },
                { speaker: 'a', text: "Do you have any favorite restaurants in the city?", translation: "¿Tienes algún restaurante favorito en la ciudad?" },
                { speaker: 'b', text: "Sí, hay un pequeño restaurante italiano cerca de mi casa que tiene la mejor pasta." }
            ],
            // Conversation 9: Future Plans
            [
                { speaker: 'a', text: "Next year, I plan to visit my family in the United States.", translation: "El próximo año, planeo visitar a mi familia en los Estados Unidos." },
                { speaker: 'b', text: "¡Qué emocionante! Yo quiero aprender a tocar la guitarra. Es uno de mis objetivos para el próximo año." },
                { speaker: 'a', text: "That's a great goal! I've always wanted to learn a musical instrument too.", translation: "¡Ese es un gran objetivo! Siempre he querido aprender a tocar un instrumento musical también." },
                { speaker: 'b', text: "Tal vez podamos tomar clases juntos algún día. Sería divertido." }
            ],
            // Conversation 10: Cultural Exchange
            [
                { speaker: 'a', text: "I'm trying to improve my Spanish. Do you have any tips?", translation: "Estoy intentando mejorar mi español. ¿Tienes algún consejo?" },
                { speaker: 'b', text: "Te recomiendo ver películas españolas con subtítulos y practicar hablando con nativos, como ahora." },
                { speaker: 'a', text: "Thank you for the advice! Your English is very good too.", translation: "¡Gracias por el consejo! Tu inglés también es muy bueno." },
                { speaker: 'b', text: "Gracias. He estado estudiando inglés desde la escuela. La práctica constante es la clave." }
            ]
        ];

        // Test questions for each conversation
        const testQuestions = [
            // Tests for conversation 1
            [
                {
                    question: "How do you say 'My name is Carlos' in Spanish?",
                    options: [
                        "Me llamo Carlos",
                        "Soy Carlos",
                        "Mi nombre Carlos",
                        "Carlos me llama"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does '¿A qué te dedicas?' mean?",
                    options: [
                        "What do you do for work?",
                        "What is your name?",
                        "Where are you from?",
                        "How old are you?"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you say 'I'm a teacher' in Spanish?",
                    options: [
                        "Soy profesor/profesora",
                        "Trabajo como maestro",
                        "Enseño en escuela",
                        "Me dedico a enseñar"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 2
            [
                {
                    question: "How do you say 'I work as an engineer' in Spanish?",
                    options: [
                        "Trabajo como ingeniero",
                        "Soy ingeniero trabajando",
                        "Trabajo en ingeniero",
                        "Ingeniero es mi trabajo"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What is the Spanish word for 'teacher' (female)?",
                    options: [
                        "Profesora",
                        "Maestra",
                        "Enseñadora",
                        "Doctora"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does '¿Dónde vives?' mean?",
                    options: [
                        "Where do you live?",
                        "Where are you from?",
                        "Where do you work?",
                        "Where are you going?"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 3
            [
                {
                    question: "How do you say 'I have two sons and one daughter' in Spanish?",
                    options: [
                        "Tengo dos hijos y una hija",
                        "Soy dos hijos y una hija",
                        "Tengo dos niños y una niña",
                        "Veo dos hijos y una hija"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'me encanta pasar tiempo con ellas' mean?",
                    options: [
                        "I love spending time with them (females)",
                        "I need time with them",
                        "I have time for them",
                        "I want time with them"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you say 'I like to read books' in Spanish?",
                    options: [
                        "Me gusta leer libros",
                        "Me gusta libros",
                        "Leo libros me gusta",
                        "Libros me gustan leer"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 4
            [
                {
                    question: "How do you say 'I'm married' in Spanish?",
                    options: [
                        "Estoy casado/casada",
                        "Soy casado",
                        "Tengo esposo",
                        "Me caso"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Soy soltero' mean?",
                    options: [
                        "I'm single (male)",
                        "I'm alone",
                        "I'm married",
                        "I'm sad"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you say 'I'm an only child' in Spanish?",
                    options: [
                        "Soy hijo único/hija única",
                        "Tengo un hermano",
                        "No tengo hermanos",
                        "Soy el único niño"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 5
            [
                {
                    question: "How do you say 'In my free time' in Spanish?",
                    options: [
                        "En mi tiempo libre",
                        "En mi libre tiempo",
                        "Cuando tengo tiempo",
                        "Mi tiempo gratis"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'disfruto cocinar' mean?",
                    options: [
                        "I enjoy cooking",
                        "I dislike cooking",
                        "I need to cook",
                        "I cook well"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Te recomiendo que vayas' mean?",
                    options: [
                        "I recommend that you go",
                        "I want to go with you",
                        "You should recommend me",
                        "I will go with you"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 6
            [
                {
                    question: "How do you say 'Let me introduce myself' in Spanish?",
                    options: [
                        "Permíteme presentarme",
                        "Déjame presentar",
                        "Yo me presento",
                        "Mi introducción"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'diseñadora gráfica' mean?",
                    options: [
                        "Graphic designer (female)",
                        "Design graphics",
                        "Beautiful design",
                        "Art designer"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you ask 'How old is your daughter?' in Spanish?",
                    options: [
                        "¿Cuántos años tiene tu hija?",
                        "¿Qué edad tiene tu hija?",
                        "¿Cómo es tu hija?",
                        "¿Dónde está tu hija?"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 7
            [
                {
                    question: "How do you say 'I'm 35 years old' in Spanish?",
                    options: [
                        "Tengo 35 años",
                        "Soy 35 años",
                        "Estoy 35 años",
                        "Tengo 35 años viejo"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'desarrollador de software' mean?",
                    options: [
                        "Software developer",
                        "Software designer",
                        "Computer programmer",
                        "Technology expert"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'desde casa' mean?",
                    options: [
                        "From home",
                        "At home",
                        "To home",
                        "My home"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 8
            [
                {
                    question: "How do you say 'On weekends' in Spanish?",
                    options: [
                        "Los fines de semana",
                        "En los fines de semana",
                        "Durante los fines",
                        "Fin de semana"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'suelo ir al parque' mean?",
                    options: [
                        "I usually go to the park",
                        "I want to go to the park",
                        "I like the park",
                        "I need to go to the park"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "How would you say 'I go to the gym' in Spanish?",
                    options: [
                        "Voy al gimnasio",
                        "Estoy en el gimnasio",
                        "Tengo gimnasio",
                        "Me gusta el gimnasio"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 9
            [
                {
                    question: "How do you say 'Next year' in Spanish?",
                    options: [
                        "El próximo año",
                        "El año próximo",
                        "El año que viene",
                        "All of the above"
                    ],
                    correctAnswer: 3
                },
                {
                    question: "What does 'aprender a tocar la guitarra' mean?",
                    options: [
                        "Learn to play the guitar",
                        "Learn about guitars",
                        "Play guitar music",
                        "Buy a guitar"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'Sería divertido' mean?",
                    options: [
                        "It would be fun",
                        "It is fun",
                        "It was fun",
                        "It could be fun"
                    ],
                    correctAnswer: 0
                }
            ],
            // Tests for conversation 10
            [
                {
                    question: "How do you say 'I'm trying to improve my Spanish' in Spanish?",
                    options: [
                        "Estoy intentando mejorar mi español",
                        "Trato de mejorar mi español",
                        "Quiero mejorar mi español",
                        "Both A and B"
                    ],
                    correctAnswer: 3
                },
                {
                    question: "What does 'Te recomiendo' mean?",
                    options: [
                        "I recommend you",
                        "You recommend me",
                        "I need recommendation",
                        "You need recommendation"
                    ],
                    correctAnswer: 0
                },
                {
                    question: "What does 'La práctica constante es la clave' mean?",
                    options: [
                        "Constant practice is the key",
                        "Practice is important",
                        "You need to practice",
                        "Practice makes perfect"
                    ],
                    correctAnswer: 0
                }
            ]
        ];

        // Spanish vocabulary to highlight
        const vocabWords = [
            "Me llamo", "Soy", "Trabajo como", "Profesión", "Oficio",
            "Ingeniero", "Doctor", "Profesor", "Profesora", "Diseñador",
            "Arquitecto", "Desarrollador", "Marketing", "Medicina", "Educación",
            "Tengo hijos", "Hijo", "Hija", "Hijos", "Casado",
            "Casada", "Soltero", "Soltera", "Familia", "Hermano",
            "Hermana", "Primos", "Tiempo libre", "Me gusta", "Disfruto",
            "Leer", "Libros", "Deportes", "Fútbol", "Tenis",
            "Cocinar", "Viajar", "Pintar", "Senderismo", "Fotografía",
            "Ciclismo", "Años", "Vivo en", "Ciudad", "País",
            "Mucho gusto", "Encantado", "Encantada", "Gracias", "Por favor",
            "Permíteme", "Presentarme", "Recomiendo", "Práctica", "Clave"
        ];

        let currentConversationIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let testStarted = false;
        
        const conversationElement = document.getElementById('conversation');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');
        const testBtn = document.getElementById('test-btn');
        const testContainer = document.getElementById('test-container');
        const questionsContainer = document.getElementById('questions-container');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const results = document.getElementById('results');
        const scoreText = document.getElementById('score-text');
        const feedbackText = document.getElementById('feedback-text');
        const statusElement = document.getElementById('status');
        
        // Function to highlight vocabulary words
        function highlightVocabulary(text) {
            let highlightedText = text;
            vocabWords.forEach(word => {
                const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="vocab-highlight">$&</span>`);
            });
            return highlightedText;
        }

        function renderConversation() {
            conversationElement.innerHTML = '';
            const currentConversation = conversations[currentConversationIndex];
            
            currentConversation.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.speaker}`;
                
                // Highlight vocabulary words for Spanish messages
                let displayText = message.text;
                if (message.speaker === 'b') {
                    displayText = highlightVocabulary(message.text);
                }
                
                messageElement.innerHTML = `
                    ${displayText}
                    ${message.translation ? `<div class="translation">${message.translation}</div>` : ''}
                    <button class="speak-btn" data-text="${message.speaker === 'b' ? message.text : (message.translation || '')}" data-speaker="${message.speaker}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                `;
                conversationElement.appendChild(messageElement);
            });
            
            // Add event listeners to speak buttons
            document.querySelectorAll('.speak-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const text = e.target.closest('.speak-btn').dataset.text;
                    const speaker = e.target.closest('.speak-btn').dataset.speaker;
                    speak(text);
                });
            });
            
            // Add event listeners to messages
            document.querySelectorAll('.message').forEach(message => {
                message.addEventListener('click', (e) => {
                    if (!e.target.closest('.speak-btn')) {
                        const speaker = message.classList.contains('a') ? 'a' : 'b';
                        if (speaker === 'b') {
                            // Get the original text without HTML tags for speaking
                            const text = message.textContent.trim().split('\n')[0];
                            speak(text);
                        } else if (speaker === 'a') {
                            // For Speaker A, speak the translation if available
                            const translationElement = message.querySelector('.translation');
                            if (translationElement) {
                                speak(translationElement.textContent);
                            }
                        }
                    }
                });
            });
        }

        async function speak(text) {
            if (!text) return;
            
            updateStatus('Converting text to speech...', 'active');
            
            try {
                const audio = await puter.ai.txt2speech(text, {
                    provider: 'openai',
                    voice: 'nova',
                    model: 'gpt-4o-mini-tts',
                    response_format: 'mp3'
                });
                
                updateStatus('Playing audio...', 'active');
                
                await audio.play();
                
                // Reset status when audio finishes
                audio.addEventListener('ended', () => {
                    updateStatus('', '');
                });
                
                audio.addEventListener('error', (e) => {
                    updateStatus('Error playing audio', 'active');
                    console.error('Audio playback error:', e);
                });
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'active');
                console.error('TTS Error:', error);
                
                // Fallback to browser TTS if OpenAI fails
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    speechSynthesis.speak(utterance);
                    
                    utterance.onend = () => {
                        updateStatus('', '');
                    };
                }
            }
        }

        function updateStatus(message, className) {
            statusElement.textContent = message;
            statusElement.className = 'status';
            if (className) {
                statusElement.classList.add(className);
            }
        }

        function startTest() {
            testStarted = true;
            currentQuestionIndex = 0;
            userAnswers = new Array(testQuestions[currentConversationIndex].length).fill(null);
            testContainer.classList.add('active');
            renderQuestion();
            updateTestControls();
            results.classList.remove('show');
        }

        function renderQuestion() {
            questionsContainer.innerHTML = '';
            const questions = testQuestions[currentConversationIndex];
            const question = questions[currentQuestionIndex];
            
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.innerHTML = `
                <div class="question-text">${currentQuestionIndex + 1}. ${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) => `
                        <div class="option ${userAnswers[currentQuestionIndex] === index ? 'selected' : ''}" data-index="${index}">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;
            
            questionsContainer.appendChild(questionElement);
            
            // Add event listeners to options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Store user's answer
                    userAnswers[currentQuestionIndex] = parseInt(option.dataset.index);
                    
                    // Enable check answer button
                    checkAnswerBtn.disabled = false;
                });
            });
        }

        function updateTestControls() {
            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            nextQuestionBtn.disabled = currentQuestionIndex === testQuestions[currentConversationIndex].length - 1;
            checkAnswerBtn.disabled = userAnswers[currentQuestionIndex] === null;
        }

        function checkAnswer() {
            const questions = testQuestions[currentConversationIndex];
            const question = questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            
            // Show correct/incorrect styling
            document.querySelectorAll('.option').forEach(option => {
                const index = parseInt(option.dataset.index);
                if (index === question.correctAnswer) {
                    option.classList.add('correct');
                } else if (index === userAnswer && userAnswer !== question.correctAnswer) {
                    option.classList.add('incorrect');
                }
            });
            
            // Disable further selection
            document.querySelectorAll('.option').forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            checkAnswerBtn.disabled = true;
            
            // If this is the last question, show results
            if (currentQuestionIndex === questions.length - 1) {
                showResults();
            }
        }

        function showResults() {
            const questions = testQuestions[currentConversationIndex];
            let correctCount = 0;
            
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) {
                    correctCount++;
                }
            });
            
            const score = Math.round((correctCount / questions.length) * 100);
            scoreText.textContent = `Your Score: ${score}% (${correctCount}/${questions.length})`;
            
            // Provide feedback based on score
            if (score >= 90) {
                feedbackText.textContent = "¡Excelente! You have a great understanding of these Spanish conversations.";
            } else if (score >= 70) {
                feedbackText.textContent = "¡Muy bien! You understood most of the Spanish conversations.";
            } else if (score >= 50) {
                feedbackText.textContent = "Not bad! Review the conversation and try again.";
            } else {
                feedbackText.textContent = "Keep practicing! Listen to the conversation again and pay attention to the Spanish phrases.";
            }
            
            results.classList.add('show');
        }

        // Event listeners for conversation navigation
        prevBtn.addEventListener('click', () => {
            if (currentConversationIndex > 0) {
                currentConversationIndex--;
                renderConversation();
                testContainer.classList.remove('active');
                testStarted = false;
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentConversationIndex < conversations.length - 1) {
                currentConversationIndex++;
                renderConversation();
                testContainer.classList.remove('active');
                testStarted = false;
            }
        });

        resetBtn.addEventListener('click', () => {
            currentConversationIndex = 0;
            renderConversation();
            testContainer.classList.remove('active');
            testStarted = false;
        });

        testBtn.addEventListener('click', () => {
            startTest();
        });

        // Event listeners for test navigation
        prevQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
                updateTestControls();
            }
        });

        nextQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex < testQuestions[currentConversationIndex].length - 1) {
                currentQuestionIndex++;
                renderQuestion();
                updateTestControls();
            }
        });

        checkAnswerBtn.addEventListener('click', checkAnswer);

        // Initial render
        renderConversation();
    </script>
</body>
</html>